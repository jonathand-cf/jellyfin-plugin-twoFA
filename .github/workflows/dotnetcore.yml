name: Release Jellyfin 2FA Plugin

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install MinVer
        run: |
          dotnet tool install --global minver-cli
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Calculate version
        id: minver
        run: |
          TAG_PREFIX=""
          if git tag -l "v*" | grep -q .; then
            TAG_PREFIX="v"
          fi
          if [ -n "$TAG_PREFIX" ]; then
            VERSION="$(minver -t "$TAG_PREFIX")"
          else
            VERSION="$(minver -t "")"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Publish Plugin
        run: dotnet publish Jellyfin.Plugin.2FA/Jellyfin.Plugin.2FA.csproj -c Release -o ./publish -p:Version=${{ env.VERSION }}

      - name: Create Release Zip
        run: |
          ZIP_NAME="Jellyfin.Plugin.2FA-${VERSION}.zip"
          cd publish
          zip -r "../${ZIP_NAME}" .
          cd ..
          echo "ZIP_NAME=${ZIP_NAME}" >> "$GITHUB_ENV"

      - name: Create manifest
        run: |
          CHECKSUM="$(md5sum "${ZIP_NAME}" | awk '{print $1}')"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          cat > manifest.json <<EOF
          [
            {
              "guid": "48B36D30-3FC5-4560-9920-98EC434DAB1D",
              "name": "2FA",
              "overview": "Standalone 2FA login flow for Jellyfin with TOTP enrollment.",
              "description": "Provides a dedicated /sso/2fa login page and TOTP enrollment without modifying jellyfin-web. Default Jellyfin login remains available unless redirected by a reverse proxy.",
              "owner": "jonathand-cf",
              "category": "Authentication",
              "versions": [
                {
                  "version": "${VERSION}",
                  "changelog": "See GitHub release notes.",
                  "targetAbi": "10.11.0.0",
                  "sourceUrl": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/${ZIP_NAME}",
                  "checksum": "${CHECKSUM}",
                  "timestamp": "${TIMESTAMP}"
                }
              ]
            }
          ]
          EOF

      - name: Update dist branch manifest
        run: |
          TMP_DIR="$(mktemp -d)"
          cp manifest.json "${TMP_DIR}/manifest.json"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan dist
          git rm -rf .
          cp "${TMP_DIR}/manifest.json" ./manifest.json
          git add manifest.json
          git commit -m "Update manifest for ${VERSION}"
          git push origin dist --force

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          generate_release_notes: true
          files: ${{ env.ZIP_NAME }}
